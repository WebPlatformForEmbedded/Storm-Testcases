<html>
<head>
    <title>Redirect during AJAX requests test</title>
    <!-- <link href="fontstest/fonts.css" rel="stylesheet" type="text/css" /> -->
</head>
<body style="width: 1080px; height: 720px; border: 1px green solid;">
    <div id="container" style="position: absolute; top: 75px; left: 50px; height: 50px; width: 250px; padding: 25px; background: white; color: black; border: 1px solid white;"><p id="status"></p></div>
    
    <script>

    var side = 'A'; //this tape has two side, side A and B. But no worries, this tape deck auto-reverses.
    var wait = 200; // in ms by default
    var runs = -1; // run for infinity by default
    var requests = 20;
    var run = 0;    
    var querystring = window.location.search;

    if (querystring){
        var search = querystring.split('?')[1];
        
        if (search) {
            var params = search.split('&');

            for (var i=0; i<params.length; i++){
                var param = params[i].split('=');

                if (param[0] === 'wait') wait = parseInt(param[1]);
                if (param[0] === 'run') run = parseInt(param[1]);
                if (param[0] === 'runs') runs = parseInt(param[1]);
                if (param[0] === 'requests') requests = parseInt(param[1]);
                if (param[0] === 'side') side = param[1]; 
            }
        }

    }

    function httpRequest(method, url, body, cB) {
        if ((method !== null) && (method !== 'undefined') &&
            (url !== null) && (url !== 'undefined') &&
            (cB !== null) && (cB !== 'undefined') && (cB.constructor.name == 'Function')) {
            var xhttp = new XMLHttpRequest();
            var aSync = true;

            xhttp.open(method, url, aSync);
            xhttp.onreadystatechange = function() {
                var response = null;
                var httpHelper_Err = null;

                //console.log('xhttp STATE CHANGE: ' + xhttp.readyState + ' status:' + xhttp.status);
                if (xhttp.readyState === 4) {
                    if (xhttp.status >= 200 && xhttp.status <= 299) {
                        //check if we have a body
                        if (xhttp.responseText.length > 0) {
                            //console.log('RESP: ' + xhttp.responseText);
                            this.response = xhttp.responseText;
                            cB(this.response, this.httpHelper_Err);
                        } else {
                            //send atleast an OK if we have an empty 200 OK
                            cB('{"status" : "OK"}', this.httpHelper_Err);
                        }
                    } else if (xhttp.status === 0) {
                        //console.log('xhttp status 0 - Request ' + method + ' - ' + url + ' aborted');
                        cB(null, 'Aborted');
                    } else {
                        console.log('ERR: ' + xhttp.responseText);
                        this.httpHelper_Err = xhttp.responseText;
                        cB(null, this.httpHelper_Err);
                    }
                }
            };

            //console.log('xhttp BODY: ' + body);
            xhttp.send(body);
        } else {
            throw 'HttpHelper error: method, url or callback not defined';
        }

    };

    function doQueries(){
        for (var i=0; i<requests; i++){
            var timestamp = new Date().getTime(); // avoid cache
            httpRequest('GET', 'http://cdn.metrological.com/speedtest/100k.eot?stamp=' + timestamp, undefined, function(resp, err){});
        }
    }

    function keepAlive(){
        httpRequest('GET', '/keepalive', undefined, function (resp, err){});
    }

    function doNavigate(){
        if (side == 'A') window.location.href = '/app?run=' + run + '&runs=' + runs + '&wait=' + wait + '&requests=' + requests + '&side=B';   
        if (side == 'B') window.location.href = '/app2?run=' + run + '&runs=' + runs + '&wait=' + wait + '&requests=' + requests + '&side=A';      
    }

    function runtest(){
        doQueries();
        var loop = setTimeout(doNavigate, wait);
        run++;
    }

    var status = 'Redir test - running ' + run + ' of ' + runs;
    console.log(status);
    document.getElementById('status').innerHTML = status;

    keepAlive();
    setTimeout(runtest, 500);

    </script>
</body>
</html>
